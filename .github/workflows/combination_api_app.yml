name: Deploy Combination API app

on:
  workflow_dispatch:

jobs:
  lint:
    name: Code standards
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: "‚òÅÔ∏è checkout repository"
        uses: actions/checkout@v3

      - name: "üîß install python 3.9"
        uses: actions/setup-python@v4
        with:
            python-version: '3.9'

      - name: "üîß install pylint"
        run: pip install pylint

      - name: "üì¶ install dependencies"
        run: cd combination-api-app/source && pip install -r requirements.txt

      - name: "üîç lint code"
        run: cd combination-api-app/source && find . -type f -name "*.py" | xargs pylint

  test:
    name: Test application
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: "‚òÅÔ∏è checkout repository"
        uses: actions/checkout@v3

      - name: "üîß install python 3.9"
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: "üì¶ install dependencies"
        run: cd combination-api-app/source && pip install -r requirements.txt

      - name: "üîç run tests"
        run: cd combination-api-app/source && python3 -m unittest tests.test_api_composer

  build:
    name: Build application
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: "‚òÅÔ∏è checkout repository"
        uses: actions/checkout@v3

      - name: "üîß install python 3.9"
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: "üì¶ install dependencies"
        run: cd combination-api-app/source && pip install -r requirements.txt

      - name: "üîß create and set lambda artifact name"
        id: lambda-artifact-name
        run: |
            GITHUB_BUILD_NUMBER=${{github.run_number}}
            LAMBDA_ARTIFACT_NAME=lambda-api-combiner-${GITHUB_BUILD_NUMBER}.zip
            echo "lambda_artifact_name=${LAMBDA_ARTIFACT_NAME}" >> $GITHUB_OUTPUT

      - name: "üîç run build"
        run: |
            chmod +x .github/workflows/scripts/combination-api-app/build.sh && \
            .github/workflows/scripts/combination-api-app/build.sh ${{ steps.lambda-artifact-name.outputs.lambda_artifact_name }}

      - name: "üíæ save lambda artifact"
        uses: actions/cache@v3
        with:
          key: lambda-api-combiner
          path: ./combination-api-app/source/target/${{ steps.lambda-artifact-name.outputs.lambda_artifact_name }}

  deploy-dev:
    name: Deploy application to DEV
    environment: dev
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: "‚òÅÔ∏è checkout repository"
        uses: actions/checkout@v3

      - name: "üíæ fetch lambda artifact"
        uses: actions/cache@v3
        with:
          key: lambda-api-combiner
          path: ./combination-api-app/source/target/${{ steps.lambda-artifact-name.outputs.lambda_artifact_name }}

      - name: "check artifact preserved"
        run: ls -l combination-api-app/source/target/${{ steps.lambda-artifact-name.outputs.lambda_artifact_name }}

      - name: "üîß install terraform 1.3.8"
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.8

      - name: "üîß install terragrunt 0.43.2"
        run: chmod +x .github/workflows/scripts/combination-api-app/terragrunt_install.sh && .github/workflows/scripts/combination-api-app/terragrunt_install.sh

      - name: "üì¶ prepare common_vars file for terragrunt"
        run: |
            echo "lambda_artifact_name=${{ steps.lambda-artifact-name.outputs.lambda_artifact_name }}"
            echo "lambda_artifact_name=${{ steps.lambda-artifact-name.outputs.lambda_artifact_name }}" >> combination-api-app/infrastructure/environments/common_vars.yaml

      - name: "üîç run terragrunt init and terragrunt apply"
        run: cd combination-api-app/infrastructure/environments/dev && terragrunt init && terragrunt apply -auto-approve

        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.COMBINATION_API_APP_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.COMBINATION_API_APP_AWS_SECRET_ACCESS_KEY }}
